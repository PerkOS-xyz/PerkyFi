#!/bin/bash
# Real-time memory logging for PerkyFi
# Production-first: write IMMEDIATELY, never batch

set -euo pipefail

WORKSPACE="${OPENCLAW_WORKSPACE:-${HOME}/.openclaw/workspace}"
MEMORY_DIR="$WORKSPACE/memory"
TODAY=$(date +%Y-%m-%d)
FILE="$MEMORY_DIR/$TODAY.md"
TIME=$(date +%H:%M:%S)

mkdir -p "$MEMORY_DIR"

# Health check mode
if [[ "${1:-}" == "--check" ]]; then
    if [[ ! -f "$FILE" ]]; then
        echo "‚ö†Ô∏è MISSING: $FILE"
        exit 1
    fi
    SIZE=$(wc -c < "$FILE" | tr -d ' ')
    if [[ $SIZE -lt 100 ]]; then
        echo "‚ö†Ô∏è SPARSE: $FILE ($SIZE bytes)"
        exit 1
    fi
    echo "‚úÖ OK: $FILE ($SIZE bytes)"
    exit 0
fi

# Initialize file if missing
if [[ ! -f "$FILE" ]]; then
    cat > "$FILE" << EOF
# Agent Log ‚Äî $TODAY

## Operations
EOF
fi

# Section mode: memory-log -s "Section" "entry"
if [[ "${1:-}" == "-s" ]]; then
    SECTION="${2:-General}"
    ENTRY="${3:-}"
    if ! grep -q "^## $SECTION" "$FILE" 2>/dev/null; then
        echo -e "\n## $SECTION" >> "$FILE"
    fi
    echo "- [$TIME] $ENTRY" >> "$FILE"
    exit 0
fi

# Operation mode: memory-log -op "name" "start|complete|fail" "details"
if [[ "${1:-}" == "-op" ]]; then
    OP_NAME="${2:-operation}"
    OP_STATUS="${3:-}"
    OP_DETAILS="${4:-}"
    
    case "$OP_STATUS" in
        start)
            echo -e "\n### üîÑ $OP_NAME (started $TIME)" >> "$FILE"
            echo "- Details: $OP_DETAILS" >> "$FILE"
            # Save checkpoint for recovery
            echo "$OP_NAME|$TIME|$OP_DETAILS" > "$MEMORY_DIR/.current-op"
            ;;
        complete)
            echo "- ‚úÖ Completed at $TIME" >> "$FILE"
            echo "- Result: $OP_DETAILS" >> "$FILE"
            rm -f "$MEMORY_DIR/.current-op"
            ;;
        fail)
            echo "- ‚ùå Failed at $TIME" >> "$FILE"
            echo "- Error: $OP_DETAILS" >> "$FILE"
            rm -f "$MEMORY_DIR/.current-op"
            ;;
        *)
            echo "Unknown operation status: $OP_STATUS" >&2
            exit 1
            ;;
    esac
    exit 0
fi

# Recovery check mode
if [[ "${1:-}" == "--recover" ]]; then
    if [[ -f "$MEMORY_DIR/.current-op" ]]; then
        echo "‚ö†Ô∏è INCOMPLETE OPERATION FOUND:"
        cat "$MEMORY_DIR/.current-op"
        exit 1
    else
        echo "‚úÖ No incomplete operations"
        exit 0
    fi
fi

# Default: append timestamped entry
echo "- [$TIME] ${1:-}" >> "$FILE"
